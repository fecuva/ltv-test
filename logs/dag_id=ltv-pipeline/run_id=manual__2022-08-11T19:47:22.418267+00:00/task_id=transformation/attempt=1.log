[2022-08-11 19:47:49,492] {taskinstance.py:1179} INFO - Dependencies all met for <TaskInstance: ltv-pipeline.transformation manual__2022-08-11T19:47:22.418267+00:00 [queued]>
[2022-08-11 19:47:49,499] {taskinstance.py:1179} INFO - Dependencies all met for <TaskInstance: ltv-pipeline.transformation manual__2022-08-11T19:47:22.418267+00:00 [queued]>
[2022-08-11 19:47:49,501] {taskinstance.py:1376} INFO - 
--------------------------------------------------------------------------------
[2022-08-11 19:47:49,502] {taskinstance.py:1377} INFO - Starting attempt 1 of 1
[2022-08-11 19:47:49,503] {taskinstance.py:1378} INFO - 
--------------------------------------------------------------------------------
[2022-08-11 19:47:49,513] {taskinstance.py:1397} INFO - Executing <Task(PythonOperator): transformation> on 2022-08-11 19:47:22.418267+00:00
[2022-08-11 19:47:49,517] {standard_task_runner.py:52} INFO - Started process 273 to run task
[2022-08-11 19:47:49,520] {standard_task_runner.py:79} INFO - Running: ['***', 'tasks', 'run', 'ltv-pipeline', 'transformation', 'manual__2022-08-11T19:47:22.418267+00:00', '--job-id', '323', '--raw', '--subdir', 'DAGS_FOLDER/dag-test.py', '--cfg-path', '/tmp/tmpsdcce3ya', '--error-file', '/tmp/tmp9wwnk8n0']
[2022-08-11 19:47:49,522] {standard_task_runner.py:80} INFO - Job 323: Subtask transformation
[2022-08-11 19:47:49,571] {task_command.py:371} INFO - Running <TaskInstance: ltv-pipeline.transformation manual__2022-08-11T19:47:22.418267+00:00 [running]> on host f961364be009
[2022-08-11 19:47:49,618] {taskinstance.py:1591} INFO - Exporting the following env vars:
AIRFLOW_CTX_DAG_OWNER=***
AIRFLOW_CTX_DAG_ID=ltv-pipeline
AIRFLOW_CTX_TASK_ID=transformation
AIRFLOW_CTX_EXECUTION_DATE=2022-08-11T19:47:22.418267+00:00
AIRFLOW_CTX_TRY_NUMBER=1
AIRFLOW_CTX_DAG_RUN_ID=manual__2022-08-11T19:47:22.418267+00:00
[2022-08-11 19:47:49,627] {base.py:68} INFO - Using connection ID 'postgres' for task execution.
[2022-08-11 19:47:49,632] {dbapi.py:231} INFO - Running statement: ALTER TABLE vehicles ADD COLUMN miles_range  VARCHAR;, parameters: None
[2022-08-11 19:47:49,642] {base.py:68} INFO - Using connection ID 'postgres' for task execution.
[2022-08-11 19:47:49,645] {dbapi.py:231} INFO - Running statement: UPDATE vehicles SET miles_range = CASE WHEN miles = 0 THEN 'new' WHEN miles >0 and miles <=3000  THEN 'semi-new' ELSE 'used' END;, parameters: None
[2022-08-11 19:47:51,360] {dbapi.py:239} INFO - Rows affected: 499998
[2022-08-11 19:47:51,385] {base.py:68} INFO - Using connection ID 'postgres' for task execution.
[2022-08-11 19:47:51,586] {logging_mixin.py:115} INFO -                 0         1       2
miles_range   new  semi-new    used
count        4746     24761  470491
[2022-08-11 19:47:51,594] {base.py:68} INFO - Using connection ID 'postgres' for task execution.
[2022-08-11 19:47:51,598] {dbapi.py:231} INFO - Running statement: 
                ALTER TABLE vehicles ADD COLUMN new_fuel_type  VARCHAR;

                UPDATE vehicles 
                SET new_fuel_type =
                CASE WHEN fuel_type in ('E85 / Unleaded','Unleaded','Premium Unleaded',
                'Premium Unleaded; Unleaded','Premium Unleaded / Unleaded',
                'Unleaded; Unleaded / E85','Unleaded / E85','E85 / Premium Unleaded',
                'Premium Unleaded; Premium Unleaded / E85','Premium Unleaded / Unleaded; Unleaded') THEN 'gasoline'
				WHEN fuel_type in ('Electric / Premium Unleaded','Unleaded / Electric','Electric / Unleaded',
                'Premium Unleaded / Natural Gas','Unleaded; Unleaded / Natural Gas'
                'Compressed Natural Gas; Unleaded','Electric / Premium Unleaded; Electric / Unleaded') THEN 'hybrid'
				WHEN fuel_type in ('Diesel','Diesel; Unleaded') THEN 'diesel'
				WHEN fuel_type in ('Compressed Natural Gas') THEN 'gas'
				WHEN fuel_type in ('Electric','Electric / Hydrogen') then 'electric'
				ELSE NULL END;
                , parameters: None
[2022-08-11 19:47:53,290] {dbapi.py:239} INFO - Rows affected: 499998
[2022-08-11 19:47:53,308] {base.py:68} INFO - Using connection ID 'postgres' for task execution.
[2022-08-11 19:47:53,314] {dbapi.py:231} INFO - Running statement: 
                        ALTER TABLE vehicles
                        ADD COLUMN average_miles  FLOAT;
                        UPDATE vehicles t1
                        SET average_miles = t2.average_miles
                        FROM 
                        (select make,model,year, round(avg(miles),2) as average_miles from vehicles group by make,model,year) t2
                        WHERE t1.make = t2.make
                        AND t1.model = t2.model
                        AND t1.year = t2.year;
    
                        , parameters: None
[2022-08-11 19:47:56,757] {dbapi.py:239} INFO - Rows affected: 496278
[2022-08-11 19:47:56,793] {base.py:68} INFO - Using connection ID 'postgres' for task execution.
[2022-08-11 19:47:56,799] {dbapi.py:231} INFO - Running statement: 
                            DROP TABLE IF EXISTS  vehicles_sellers;
                            CREATE  TABLE vehicles_sellers AS 

                            with sellers_vehicles as (
                            select seller_name,street,vin from vehicles group by 1,2,3 
                            )

                            select seller_name,street, count(*) as amount_vehicles from sellers_vehicles
                            group by 1,2 
                            HAVING count(*)>=5;
    , parameters: None
[2022-08-11 19:47:57,746] {dbapi.py:239} INFO - Rows affected: 12834
[2022-08-11 19:47:57,752] {python.py:173} INFO - Done. Returned value was: None
[2022-08-11 19:47:57,781] {taskinstance.py:1420} INFO - Marking task as SUCCESS. dag_id=ltv-pipeline, task_id=transformation, execution_date=20220811T194722, start_date=20220811T194749, end_date=20220811T194757
[2022-08-11 19:47:57,839] {local_task_job.py:156} INFO - Task exited with return code 0
[2022-08-11 19:47:57,866] {local_task_job.py:273} INFO - 0 downstream tasks scheduled from follow-on schedule check
